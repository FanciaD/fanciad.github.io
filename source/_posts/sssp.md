---
title: '[paper] Negative Weight SSSP'
date: '2025-03-16 05:09:57'
updated: '2025-03-16 05:09:57'
tags: Fancia
permalink: RingonoNegoto/
description: Negative Weight SSSP
mathjax: true
---

免责声明：我发现之前写的版本有至少三处错误。

所有时间以 CST 为准。

### Real Weight SSSP V2

#### mn^8/9

简化：

1. 假设每个点只有一条负权出边，不然单独来一个点放所有负权出边。
2. 假设度数均匀，不然拆点。

##### Reweighting, Layer 3

根据经典的 Johnson Reweighting，我们可以找一个 $d(u)$，然后将边权 $w(u,v)$ 变成 $w(u,v)+d(u)-d(v)$。如果对于每条边都有 $w'(u,v)=w(u,v)+d(u)-d(v)\geq 0$，那就搞完了。

一个显然满足这东西的 $d$ 就是某个单源最短路，也可以是全源最短路，而对于求最短路我们有：

> 假设图里面只有 $k$ 条负权边，那可以搞一个分层图，记 $d^i(u)$ 表示任意一个点出发，走不超过 $i$ 条负权边到 $u$ 的最短距离。

但这样搞是个暴力，显然不行。

一个优化是说，如果对于一个点 $u$，所有到 $u$ 且经过不超过 $k$ 条负权边的路径都是非负（总权值）的，那我们不会用中途经过这个点的路径去更新其它点（不如直接切掉），从而这个点只需要在第一层和最后一层出现。

虽然直接用不大可能，但是可以分块：如果对于某个稍微小一点的 $r$，有很多点满足 $d^r(u)=0$，那造一个 $r$ 层的分层，然后做 $k/r$ 次求出每一个 $d^{c\cdot k/r}$。每次更新下一个的时候，上面的分析仍然成立（不管初始值），所以总复杂度是 $m(r+k/r)+mk*(每次剩下的点数)/n$。

但这还是很难，因为初始有 $n$ 条负权边，这样搞 $r>1$ 就很难了。

因此考虑，每次拿一部分负权边出来做上面的过程。如果我们能找到 $k$ 条边，使得走 $r$ 条边后能负权到的点数只有 $n/r$ 级别，这样每一轮就是 $m(r+k/r)$，然后做 $n/k$ 轮。



##### Reweighting, Layer 2

我们的目标是，选出一些负权边，记 $U$ 表示这些边起点的点集，我们的目标是使得尽量多的点满足 $d^r(U,x)\geq 0$。

但上面那个目标还是不直接可能：如果有一条特别大的负权边（单向的），就全寄了。

这里的做法是直接再来一次 Reweighting：目标是操作完尽量多的 $d^r(U,x)\geq 0$。那直接来一次多源最短路……但可能 $d^r(U,U)<0$，那就炸了。

也就是说我们需要一个东西满足 $d(U)=0$，然后 $d(x)$ 尽量不大于 $d^r(U,x)$。这样在 $U$ 附近可能不大对，然后希望这样的点比较少。

那考虑取 $\min(0,\max(d^r(U,x),-d^r(x,U)))$ 来解决第一部分。注意到如果两个 metric 都对一些边满足三角形不等式，那它们的 $\min,\max$ 都满足。

1. $\max$ 满足的原因是，如果 $v$ 减了一边的，那 $u$ 那一边加上去的一定足够大。
2. $\min$ 满足的原因是，如果 $u$ 加了一边的，那 $v$ 减的那一边一定比较小。



这样一波操作完，不好的点就是那些第一步取右边的，或者说 $d^r(U,x)+d^r(x,U)<0$ 的。



##### Sandwich Construction

但这东西太复杂，因此考虑找 $(x,U,y)$，满足 $\forall u\in U,d_1(x,u),d_1(u,y)\leq0$。

然后不好的点的必要条件是，$d^{r+1}(x,v)+d^{r+1}(v,y)<0$。

首先考虑怎么找到一个很大的 $U$。先看只有 $d_1(x,u)$ 的情况。此时如果有一个大的我们可以找到 $x$，否则每个点 $x$ 都只有 $k^{2/3}$ 个 $d_1(x,u)<0$。

> 虽然我们不能算出所有 $d_1(x,u)$，但是可以采样近似集合大小。

如果是前者情况，我们再往集合里面跑第二轮放入 $y$。否则，考虑贪心选，可以得到 $k^{1/3}$ 个点，使其两两 $d_1\geq 0$。同时每个点都是一条负权边的入边。



##### Solve Far Set

如果是第二种情况，那直接同时消所有负权边，把负权边出去的权值增大，然后往外推。根据性质不会推到集合内剩下的负权边上去。然后就直接消掉 $U^{1/3}$。



##### Solve Sandwich, Reweighting Layer 1

然后考虑有一个 $(x,y)$ 的情况，此时需要让 $d^{r+1}(x,v)+d^{r+1}(v,y)<0$ 的点比较少。那显然得再做一次 reweighting。

考虑随机选一个点 $t$，然后让 $d^{r+1}(x,t),d^{r+1}(t,y)\geq0$……但这好像对别的点没啥用，尤其是如果Sandwich 就是极端的三层，每个点一条路径的时候……但即使是这样，对于每个点 $u$ 考虑它的距离：$d^{r+1}(x,t)+d^{r+1}(t,y)$。这样操作之后，相当于这个距离变成了 $0$，但这样其它的距离也增加了这个值，因为这是 Johnson Reweighting。因此这样期望让 $<0$ 的只剩一半。一般情况下，随机 $O(r\log n)$ 个点，就只剩下 $n/r$ 的大小。

然后需要做一个 Reweighting，使得一堆 $d^{r+1}(x,t),d^{r+1}(t,y)\geq0$。

然后把所有的 $d^{r+1}(x,t),d^{r+1}(t,y)$ 拿出来，做一个 $O(r\log n)$-reweighting。此时复杂度 $O(r^2m)$，使得上面任意拿出一对 $(x,y)$ 都可以满足 $\leq n/r$。

那么和外面平衡的最好结果就是每次拿进来 $k$ 条边的话，取 $r=k^{1/3}$，以 $k^{2/3}$ 的代价消边，从而除掉一个 $k^{1/3}$。因为 $k=n^{1/3}$，所以复杂度是上面那个。

#### mn^4/5

> 我们只需要造更大的 Sandwich。

考虑跑 $k$ 条负边最短路。此时有如下情况：

1. 第 $k$ 轮啥都没发生，这说明我们已经求出了最短路。
2. 如果有更新，那说明 $s$ 到 $t$ 有一条路径（权值为负）经过了 $k$ 条负权边——此时可以进一步判断出如下两种情况之一：
3. 如果这些边有重复，那么有负环。
4. 否则，$s$ 到 $t$ 的最短路经过至少 $k$ 条不同负权边。

那第四条有什么用呢？注意到所有这些负权边的点都在 Sandwich 里面。我们希望说找到的东西 Sandwich 比较大，这样上面就能一步到位。那考虑随机 sample 负权边进来，然后跑上述做法。如果找到一个至少经过 $k$ 条不同负权边的路径，那它原来的 Sandwich 必定很大——如果以 $1/t$ 去 Sample，那要么解决了 $n/t$ 条边，要么有一个 Sandwich，原来至少是 $kt$ 级别的。

如果是前者那就直接搞定了。如果是后者，那按照之前的方式，取 $r=(kt)^{1/3}$ 然后跑上面那堆。

然后取 $k=n^{1/5},t=n^{2/5}$，这样无论如何都解决了 $n^{3/5}$，时间 $n^{2/5}$，所以是 $mn^{4/5}$。